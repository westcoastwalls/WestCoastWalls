<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login - WestCoastWalls</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .login-card { background:#fff; padding:40px; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,.2); width:100%; max-width:400px; }
    h1 { text-align:center; color:#667eea; margin-bottom:10px; font-size:32px; }
    .subtitle { text-align:center; color:#666; margin-bottom:30px; font-size:14px; }
    .form-group { margin-bottom:20px; }
    label { display:block; margin-bottom:8px; font-weight:600; color:#333; }
    input { width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px; transition:border .3s; }
    input:focus { outline:none; border-color:#667eea; }
    .btn { width:100%; padding:12px; background:#667eea; color:#fff; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; transition:background .3s; }
    .btn:hover { background:#5568d3; }
    .error { background:#f8d7da; color:#721c24; padding:10px; border-radius:5px; margin-bottom:20px; display:none; }
    .default-creds { margin-top:20px; padding:15px; background:#e7f3ff; border-radius:8px; font-size:12px; color:#004085; }
    .default-creds strong { display:block; margin-bottom:5px; }
  </style>
</head>
<body>
  <div class="login-card">
    <h1>üèóÔ∏è WestCoastWalls</h1>
    <p class="subtitle">Project Management System</p>

    {% if error %}
      <div class="error" style="display:block">{{ error }}</div>
    {% else %}
      <div id="error" class="error"></div>
    {% endif %}

    <!-- HTML form fallback works even if JS fails -->
    <form id="loginForm" method="POST" action="{{ url_for('login') }}" novalidate>
      <div class="form-group">
        <label for="username">Username</label>
        <input name="username" id="username" type="text" required autofocus />
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input name="password" id="password" type="password" required />
      </div>
      <button type="submit" class="btn">Login</button>
    </form>

    <div class="default-creds">
      <strong>Default Login:</strong>
      Username: admin<br/>
      Password: admin123
    </div>
  </div>

  <script>
    (function () {
      const form = document.getElementById('loginForm');
      const err = document.getElementById('error');

      function showError(msg) {
        if (!err) return;
        err.textContent = msg || 'Login failed';
        err.style.display = 'block';
      }

      form.addEventListener('submit', async (e) => {
        // Progressive enhancement: try AJAX; on failure, fall back to normal submit
        e.preventDefault();

        const payload = {
          username: document.getElementById('username').value.trim(),
          password: document.getElementById('password').value
        };

        try {
          const res = await fetch(form.action, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',         // ensure session cookie works
            redirect: 'follow',
            body: JSON.stringify(payload)
          });

          // If server returned HTML (non-JSON), fall back to full submit
          const contentType = res.headers.get('Content-Type') || '';
          if (!contentType.includes('application/json')) {
            form.removeEventListener('submit', arguments.callee);
            form.submit();
            return;
          }

          const data = await res.json().catch(() => ({}));

          if (res.ok && data && data.success) {
            window.location.href = '/';
          } else {
            showError((data && data.message) || `Login failed (${res.status})`);
          }
        } catch (errAny) {
          // Network or other error: fallback to normal form POST
          form.removeEventListener('submit', arguments.callee);
          form.submit();
        }
      });
    })();
  </script>
</body>
</html>
